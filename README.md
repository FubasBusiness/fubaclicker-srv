# Fubaclicker API

Backend service for the Fuba Clicker game built on the Bun runtime with the Elysia web framework. The server uses Drizzle ORM to talk to PostgreSQL, issues JWT access tokens plus rotating opaque refresh tokens, and exposes a small set of authenticated player endpoints.

## Application Entry Point

`src/index.ts` wires the application by composing Elysia plugins:

- Pulls in `@elysiajs/openapi` to expose OpenAPI documentation.
- Registers the `userController`, `authController`, and `rankingController` feature modules.
- Starts the HTTP server on port `3000`.

Each controller is an isolated Elysia instance that contributes a specific route group before being mounted in the main app.

## Feature Modules

- **Authentication (`src/features/auth`)**  
  Handles `POST /auth/login` and `POST /auth/register`, hashes credentials with `Bun.password`, and manages refresh-token families (`repository/`). The `auth.macro.ts` file exposes reusable guards that verify the `Authorization` header, rotate refresh tokens when near expiry, and inject the authenticated `userId`.

- **Users (`src/features/user`)**  
  Secures `/user` routes with the auth macro. `GET /user/` returns the current player profile, normalising nullable JSON fields from the `users` table. `PUT /user/` expects an obfuscated payload; the `deobfuscate` macro decodes and validates the body before calling the update use case.

- **Ranking (`src/features/ranking`)**  
  Provides `GET /ranking/`, returning the top 50 usernames ordered by their Fuba balance. The route requires authentication.

Shared utilities live under `src/shared/` (crypto helpers and custom error types). Database primitives are centralised in `src/db/`, where `db/index.ts` exports a Drizzle client configured with the `users` and `refresh_tokens` schemas. SQL migrations live under `src/db/migrations/`.

## Directory Outline

```
src/
├── index.ts                # Elysia bootstrap and plugin registration
├── features/
│   ├── auth/               # Login, register, refresh token macros and repos
│   ├── user/               # Authenticated user profile routes and macros
│   └── ranking/            # Leaderboard route
├── db/
│   ├── schema/             # Drizzle table definitions
│   ├── migrations/         # SQL migrations generated by drizzle-kit
│   └── utils/              # Domain-specific helpers (e.g., Fuba units)
└── shared/                 # Cross-cutting helpers (crypto, errors)
```

## Environment

Set the following variables (for local development you can use a `.env` file and load it before running the server):

- `FubaDB` – PostgreSQL connection string used by Drizzle and the migration tooling. Required.
- `JWT_SECRET` – Secret key for signing and verifying access tokens. Defaults to `dev-secret` when omitted, but should be set in production.

## Getting Started

1. Install dependencies:
   ```bash
   bun install
   ```
2. Apply database migrations (example using drizzle-kit):
   ```bash
   bunx drizzle-kit migrate
   ```
3. Run the development server with live reload:
   ```bash
   bun run dev
   ```

The API listens on `http://localhost:3000`. OpenAPI documentation is available through the `@elysiajs/openapi` plugin (default route `/swagger`).

## Next Steps

- Add tests around the use-cases to guard the database and token rotation logic.
- Expand the OpenAPI schemas for ranking and user updates to document all returned fields.
